<%- include('include/head.ejs') %> 
<%- include('include/titleBar.ejs') %> 
<%-include('include/sideNavBar.ejs') %> 

<% let loginParticipante = ''; %>
<% for (grupo of grupos) { %>
  <div class="row">
    <div class="col s12 m6">
      <h5>Terapeuta: <%= grupo.nombreUsuario%> <%= grupo.apellidoPaterno%></h5>
    </div>
    <div class="col s12 m6">
      <h5>Promedio General: X</h5>
      <a class="btn-flat modal-trigger" href="#rPuntaje-correo006">Prueba</a>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Participantes</th>
        <th>Nivel</th>
        <th>Calificaciones</th>
      </tr>
    </thead>
    </tbody>
    <% for (participante of participantes) { %>
      <% if (participante.login !== loginParticipante && participante.idGrupo === grupo.idGrupo) { %>
        <tr>
          <td>
            <a  onclick="registroPuntajes(<%=grupo.idGrupo%>,'<%=participante.login%>')" class="btn-flat modal-trigger" href="#rPuntaje-<%=participante.login%>">
              <%=participante.nombreUsuario%>  <%=participante.apellidoPaterno%>    <%=participante.apellidoMaterno%>  
            </a>
          </td>
          <td>  <%=participante.nombreNivel%>  </td>
          <td></td>
        </tr>
          <% loginParticipante = participante.login;%>
        <% } %>
      <% } %>
    </tbody>
  </table>
  <br /><br />
<% } %>
  <div id="modal_objetivos"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('.modal');
    var instances = M.Modal.init(elems);
  });
  const registroPuntajes = (idGrupo, login) => {
    let data = {
      grupo_id: idGrupo,
      login_participante: login
    };
    console.log(data);
    //función que manda la petición asíncrona
    fetch('/programas/registro-puntaje', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
            //'csrf-token': csrf
        },
        body: JSON.stringify(data)
    }).then(result => {
        return result.json(); //Regresa otra promesa
    }).then(data => {
      //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
      //...
      let html = ' <div id="rPuntaje-' + data.objetivos[0].login + '" class="modal">' +
                  '<div class="modal-content">' +
                    '<table>' +
                      '<thead>' +
                        '<tr>' +
                          '<th>Objetivos</th>' +
                          '<th>Inicio</th>' +
                          '<th>Final</th>' +
                        '</tr>' +
                      '</thead>' +
                      '<tbody>' 
              for (objetivo of data.objetivos){
              html +=    '<tr>' +
                          '<td>'+ objetivo.descripcion + '</td>'+
                          '<td>' +
                            '<div class="input-field puntaje">' +
                              '<select>' +
                                '<option value="" disabled selected>___</option>';
                                for (let puntaje = 1; puntaje <= objetivo.puntajeMaximo; puntaje++) {
                                  html += '<option value="'+ puntaje + '">' + puntaje + '</option>';
                                }
              html +=         '</select>' +
                            '</div>' +
                          '</td>' +
                          '<td>' +
                            '<div class="input-field puntaje">' +
                              '<select>' +
                                '<option value="" disabled selected>___</option>';
                                for (let puntaje = 1; puntaje <= objetivo.puntajeMaximo; puntaje++) {
                                  html += '<option value="'+ puntaje + '">' + puntaje + '</option>';
                                }
              html +=         '</select>' +
                            '</div>' +
                          '</td>' +
                        '</tr>';
              }
              html += '</tbody>' +
                    '</table>' +
                    '<div class="modal-footer">' +
                      '<a href="#" class="btn modal-close">Cerrar</a>' +
                    '</div>' +
                  '</div>' +
                '</div>';

      let   html3 = '<div id="rPuntaje-correo006" class="modal">' +
                      '<div class="modal-content">'+
                        '<h4>Modal Header</h4>'+
                        ' <p>A bunch of text</p>'+
                      ' </div>'+
                      '<div class="modal-footer">'+
                        '<a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>'+
                      '</div>'+
                    '</div>';      

      document.getElementById('modal_objetivos').innerHTML = html3;
      M.AutoInit();
        
    }).catch(err => {
      console.log(err);
    });
  };
</script>
<%- include('include/footer.ejs') %>
