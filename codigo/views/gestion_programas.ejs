<%- include('include/head.ejs') %>
<%- include('include/titleBar.ejs') %>
<%- include('include/sideNavBar.ejs') %>   
<div class="row">
    <div class="col s12 m4">     
        <div class="row">
            <div class="input-field col s12" >
            <i class="material-icons prefix">search</i>
            <input type="text" id="buscarPrograma" class="autocomplete" oninput="buscarPrograma()">
            <label for="buscarPrograma">Nombre del programa</label>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="row">
          <div class="input-field col s12">
            <!-- Modal Agregar -->
             <% if (permisos.includes(1)) { %>
            <a class="btn-small modal-trigger light-green accent-4" href="#agregarPrograma"><i class="material-icons left">add_circle</i>Agregar</a>
            <% } %>
          </div>
        </div>
    </div>
    <!-- Inicia Modal Structure agregar programa-->
    <div id="agregarPrograma" class="modal">
      <%- include('includesGestion/modst_agregar_programa.ejs') %>  
    </div><!--Fin Modal Structure agregar programa-->
    
    <!-- Modals Editar programas-->
    <%- include('includesGestion/modst_editar_programa.ejs') %>  

    <div class="row">
        <div class="col s12 m12">
          <%- include('includesGestion/lista_programas.ejs') %>
        </div>
    </div>
</div>    

<input type="hidden" id="errorPrograma" value="<%=error%>">
<input type="hidden" id="registroExitoso" value="<%=registro_exitoso%>">
<%- include('include/footer.ejs') %>

<script>
  const buscarPrograma = () => {
    const csrf = document.getElementById('_csrf').value;
    let data = {criterio: document.getElementById('buscarPrograma').value}
    console.log(data)
    fetch('/gestionAdmin/gestionProgramas/buscar-programa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'csrf-token': csrf
        },
        body: JSON.stringify(data)
    }).then(result => {
        return result.json(); //Regresa otra promesa
    }).then(data => {
      //Modificamos el DOM de nuestra p√°gina de acuerdo a los datos de la segunda promesa
      //...
      let html = '';
      for (let programa of data.programas){
        html += '<li>' +
                  '<div class="collapsible-header">' +
                    programa.nombrePrograma +
                    '<span class="badge">' +
                        '<a class="waves-effect waves-light modal-trigger black-text" href="#EditarPrograma-' + programa.idPrograma + '"><i class="material-icons left">edit</i></a>' +
                    '</span>' +
                  '</div>' +
                '<div class="collapsible-body">' +
                    '<div class="collection">';
                      for(let nivel of data.niveles){
                        if(nivel.idPrograma === programa.idPrograma){
        html += '<a href="./objetivos/' + nivel.idNivel + '" class="collection-item">' + nivel.nombreNivel + '</a>'; 
                        }
                      }
        html += '<a class="collection-item modal-trigger" href="#agregarNivel-' + programa.idPrograma + '">Nuevo nivel</a>'+
                    '</div>' +
                '</div>' +
            '</li>';
      }
      document.getElementById('lista-programas').innerHTML = html;
      M.AutoInit();

    }).catch(err => {
      console.log(err);
    });
  }
  let error = document.getElementById('errorPrograma').value;
  let registro_exitoso = document.getElementById('registroExitoso').value;

</script>
<script>
  if (error !== 'false'){
    M.toast({html: error , length:7500, classes: 'black'});
  }

  if (registro_exitoso !== 'false'){
    M.toast({html: registro_exitoso ,  length:6500, classes: 'grey'});
  }
</script>